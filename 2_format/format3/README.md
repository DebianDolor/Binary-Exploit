# Analysis

* We are given with the below source code:

    ![image.png](./image.png)

* Lets try some random inputs:

    ![image-1.png](./image-1.png)

* Everything is similar to format 2 except that we now have to precisely control what is written to <span style="color:red">*target*</span>.

# Exploit

* Again, we start by locating the start of our input string.:

    ![image-2.png](./image-2.png)

* And also, the memory address of <span style="color:red">*target*</span>:

    ![image-3.png](./image-3.png)

* This shows that we are able to write to <span style="color:red">*target*</span>:

    ![image-5.png](./image-5.png)

* Since we can't write to all 4 bytes at once, we can try to write a byte a time for four times in a row.

    ![image-4.png](./image-4.png)

    - We can supply different addresses one after another on the stack and supply multiple %n parameters to write to the least significant byte of each address in sequence.

* For example, we can use the following information:

```
080496f4 -> Address 1 -> Modifies Byte 1
080496f5 -> Address 2 -> Modifies Byte 2
080496f6 -> Address 3 -> Modifies Byte 3
080496f7 -> Address 4 -> Modifies Byte 4
```

* To modify all these values, letâ€™s construct a valid structure:

```
Value1 +  Address 1 + Value2 + Address2 + Value3 + Address3 + Value4 + Address4 + '%x'*11 + "%u%n" + %u%n + %u%n + %u%n
```

* This structure contains the following:

    - value + address 4 times
    - We need the value because each %nu also pops the stack, so we need a padding before each address. 
    - 11 %x of padding
    - %u%n 4 times <- with this we will control the values of the bytes

* Lets run this:

    ![image-6.png](./image-6.png)

* So, we need to calculate the offset for each %u. I use this python script: (this was taken from https://www.ayrx.me/protostar-walkthrough-format/)

```
def calculate(to_write, written):
    to_write += 0x100
    written %= 0x100
    padding = (to_write - written) % 0x100
    if padding < 10:
        padding += 0x100
    print padding
```

* For the first byte, we need 44, and we have 67. Lets pass this as parameters to our script (0x44=68,0x67=103):

    ![image-7.png](./image-7.png)

    - So we'll use %231u:

        ![image-8.png](./image-8.png)

* Keep doing this, and we are done:

    ![image-9.png](./image-9.png)

# Bugs

* Same like previous levels, the bug is at the <span style="color:red">*printf*</span> function.

